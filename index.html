<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHAANK'S AIM TRAINER - 3D</title>
    <style>
        :root {
            --bg-color: #121212;
            --primary-color: #ff4757;
            --secondary-color: #1e1e1e;
            --font-color: #e0e0e0;
            --glow-color: #2f3542;
            --neon-cyan: #00ffff;
        }
        * { box-sizing: border-box; font-family: 'Arial', sans-serif; user-select: none; }
        body { margin: 0; background-color: var(--bg-color); color: var(--font-color); overflow: hidden; }
        #container { width: 100vw; height: 100vh; position: relative; display: flex; justify-content: center; align-items: center; }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* Reticle/Crosshair */
        #reticle {
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
        }
        #reticle.dot { background-color: var(--neon-cyan); width: 6px; height: 6px; box-shadow: 0 0 5px var(--neon-cyan); }
        #reticle.cross::before, #reticle.cross::after {
            content: '';
            position: absolute;
            background-color: var(--neon-cyan);
            box-shadow: 0 0 5px var(--neon-cyan);
        }
        #reticle.cross::before { width: 20px; height: 2px; top: 9px; left: 0; }
        #reticle.cross::after { width: 2px; height: 20px; top: 0; left: 9px; }

        /* UI & Menus */
        .menu-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(18, 18, 18, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }
        .menu {
            background-color: rgba(30, 30, 30, 0.97);
            padding: 40px; border-radius: 10px;
            text-align: center; box-shadow: 0 0 40px rgba(0, 0, 0, 0.7);
            border: 1px solid var(--glow-color); width: 90%; max-width: 600px;
        }
        .menu h1 { color: var(--primary-color); margin-top: 0; text-shadow: 0 0 8px var(--primary-color); letter-spacing: 3px; }
        .menu p { color: #aaa; margin-bottom: 30px; }
        .menu-section { margin-bottom: 25px; }
        .menu-section h3 { margin-bottom: 15px; color: var(--neon-cyan); border-bottom: 1px solid var(--glow-color); padding-bottom: 5px; font-weight: 400; text-transform: uppercase; letter-spacing: 1px; }
        button {
            background-color: var(--primary-color); color: var(--font-color); border: none; padding: 12px 25px;
            margin: 5px; border-radius: 5px; font-size: 16px; cursor: pointer; transition: all 0.2s ease;
            text-transform: uppercase; font-weight: bold; letter-spacing: 1px; min-width: 150px;
        }
        button:hover { background-color: #ff6b81; box-shadow: 0 0 15px var(--primary-color); transform: translateY(-2px); }
        .selector button { background-color: var(--secondary-color); border: 1px solid var(--glow-color); }
        .selector button.active { background-color: var(--neon-cyan); color: var(--bg-color); box-shadow: 0 0 10px var(--neon-cyan); font-weight: bold; }

        /* HUD */
        #hud { position: absolute; width: 100%; height: 100%; top: 0; left: 0; font-size: 20px; font-weight: bold; pointer-events: none; display: flex; justify-content: space-between; padding: 20px; text-shadow: 0 0 8px #000; }
        .hud-group { background: rgba(0,0,0,0.4); padding: 10px 15px; border-radius: 5px; }
        #hud-center { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); font-size: 32px; }

        /* Summary Screen */
        #summary-content { background-color: var(--secondary-color); padding: 30px; border-radius: 10px; text-align: center; width: 90%; max-width: 700px; border: 1px solid var(--glow-color); }
        #summary-content h2 { font-size: 36px; margin-top: 0; color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); }
        .summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; margin: 30px 0; text-align: center; }
        .stat-item { background: var(--bg-color); padding: 20px; border-radius: 5px; }
        .stat-item .label { font-size: 14px; color: #aaa; text-transform: uppercase; display: block; }
        .stat-item .value { font-size: 28px; font-weight: bold; color: var(--neon-cyan); }
        .stat-item .value.high-score { color: var(--primary-color); }

        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 150px; font-weight: bold; color: var(--font-color); text-shadow: 0 0 20px #000; z-index: 15; transition: all 0.2s ease-out; }
        .hidden { display: none !important; }
        @keyframes screenShake { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(1px, 0); } 50% { transform: translate(-1px, 0); } 75% { transform: translate(0, 1px); } }
        .shake { animation: screenShake 0.08s ease-in-out; }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="game-canvas"></canvas>

        <div id="reticle" class="cross"></div>
        
        <div id="start-menu" class="menu-overlay">
            <div class="menu">
                <h1>SHAANK'S AIM TRAINER</h1>
                <p>Click the screen to lock mouse control. Press ESC to pause.</p>
                <div class="menu-section">
                    <h3>Select Scenario</h3>
                    <div id="mode-selector" class="selector">
                        <button data-mode="TileFrenzy" class="active">Tile Frenzy</button>
                        <button data-mode="TargetSwitching">Target Switching</button>
                        <button data-mode="FlickShot">Flick Shot</button>
                    </div>
                </div>
                <div class="menu-section">
                    <h3>Duration (Timed Modes)</h3>
                    <div id="duration-selector" class="selector">
                        <button data-duration="30" >30s</button>
                        <button data-duration="60" class="active">60s</button>
                        <button data-duration="90">90s</button>
                    </div>
                </div>
                <button id="start-button">Start</button>
                <button id="reticle-button">Change Reticle</button>
            </div>
        </div>

        <div id="hud" class="hidden">
             <div class="hud-group">
                <div>Score: <span id="score">0</span></div>
                <div>Accuracy: <span id="accuracy">100.0</span>%</div>
            </div>
             <div id="hud-center" class="hud-group">
                <span id="time-remaining">60.0</span>
            </div>
             <div class="hud-group">
                <div id="targets-hit-label">Hits: <span id="hits">0</span> / <span id="total-targets">--</span></div>
                <div>FPS: <span id="fps">60</span></div>
            </div>
        </div>

        <div id="countdown" class="hidden">3</div>

        <div id="pause-menu" class="menu-overlay hidden">
            <div class="menu">
                <h1>PAUSED</h1>
                <button id="resume-button">Resume</button>
                <button id="restart-level-button">Restart</button>
                <button id="main-menu-button">Main Menu</button>
            </div>
        </div>

        <div id="summary-screen" class="menu-overlay hidden">
            <div id="summary-content" class="menu">
                <h2 id="summary-title">Scenario Complete!</h2>
                <div class="summary-stats">
                    <div class="stat-item"><span class="label">Final Score</span><span id="summary-score" class="value">0</span></div>
                    <div class="stat-item"><span class="label">High Score</span><span id="summary-highscore" class="value">0</span></div>
                    <div class="stat-item"><span class="label">Accuracy</span><span id="summary-accuracy" class="value">100%</span></div>
                    <div class="stat-item"><span class="label">Avg. TTK</span><span id="summary-avg-ttk" class="value">0ms</span></div>
                </div>
                <div class="summary-buttons">
                    <button id="summary-retry-button">Retry</button>
                    <button id="summary-menu-button">Main Menu</button>
                </div>
            </div>
        </div>
    </div>
    
    <audio id="hit-sound" src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"></audio>
    <audio id="shoot-sound" src="data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhSAAAAEB/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/"></audio>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof THREE === 'undefined') {
                document.body.innerHTML = "<h1>Error: Could not load Three.js. Please check your internet connection.</h1>";
                return;
            }

            // --- DOM & AUDIO ---
            const container = document.getElementById('container');
            const canvas = document.getElementById('game-canvas');
            const startMenu = document.getElementById('start-menu');
            const hud = document.getElementById('hud');
            const reticle = document.getElementById('reticle');
            const sounds = { hit: document.getElementById('hit-sound'), shoot: document.getElementById('shoot-sound') };

            // --- 3D SCENE SETUP ---
            let scene, camera, renderer, raycaster;
            let targets = [];
            const targetMaterial = new THREE.MeshStandardMaterial({ color: 0x00ffff, emissive: 0x00ffff, emissiveIntensity: 0.5 });
            const targetHitMaterial = new THREE.MeshStandardMaterial({ color: 0xff4757, emissive: 0xff4757, emissiveIntensity: 1 });
            const targetGeometry = new THREE.SphereGeometry(0.5, 32, 16);
            const ARENA_SIZE = 20;

            // --- GAME STATE & CONFIG ---
            let gameState = {
                running: false,
                paused: false,
                mode: 'TileFrenzy',
                duration: 60,
                clickCooldown: false,
                animationFrameId: null
            };
            let stats = {};
            let lastFrameTime = 0;
            const reticleStyles = ['cross', 'dot'];
            let currentReticleIndex = 0;
            
            // --- INITIALIZATION ---
            function init() {
                setupScene();
                setupUI();
                setupEventListeners();
                animate();
            }

            function setupScene() {
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x1e1e1e);

                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.y = 1.6; // Player height

                renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;

                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                scene.add(ambientLight);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(5, 10, 7.5);
                directionalLight.castShadow = true;
                scene.add(directionalLight);
                
                // Arena
                const wallGeometry = new THREE.BoxGeometry(ARENA_SIZE, ARENA_SIZE, ARENA_SIZE);
                const wallMaterial = new THREE.MeshStandardMaterial({ color: 0x2f3542, side: THREE.BackSide });
                const arena = new THREE.Mesh(wallGeometry, wallMaterial);
                scene.add(arena);

                raycaster = new THREE.Raycaster();
            }

            function setupUI() {
                // Mode Selector
                document.querySelectorAll('#mode-selector button').forEach(b => b.addEventListener('click', e => {
                    gameState.mode = e.target.dataset.mode;
                    updateActiveButton('#mode-selector', e.target);
                    const isTimed = gameState.mode !== 'FlickShot';
                    document.getElementById('duration-selector').parentElement.classList.toggle('hidden', !isTimed);
                }));
                 // Duration Selector
                document.querySelectorAll('#duration-selector button').forEach(b => b.addEventListener('click', e => {
                    gameState.duration = parseInt(e.target.dataset.duration);
                    updateActiveButton('#duration-selector', e.target);
                }));

                document.getElementById('start-button').addEventListener('click', startGame);
                document.getElementById('reticle-button').addEventListener('click', changeReticle);
                document.getElementById('resume-button').addEventListener('click', togglePause);
                document.getElementById('restart-level-button').addEventListener('click', () => { showScreen('game'); startGame(true); });
                document.getElementById('main-menu-button').addEventListener('click', () => showScreen('start-menu'));
                document.getElementById('summary-retry-button').addEventListener('click', () => { showScreen('game'); startGame(true); });
                document.getElementById('summary-menu-button').addEventListener('click', () => showScreen('start-menu'));
            }

            function setupEventListeners() {
                window.addEventListener('resize', onWindowResize);
                container.addEventListener('click', () => {
                    if (!gameState.running || gameState.paused) container.requestPointerLock();
                });
                document.addEventListener('pointerlockchange', lockChangeAlert, false);
                document.addEventListener('mousedown', (e) => {
                    if (e.button === 0 && gameState.running && !gameState.paused) shoot();
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                         if (document.pointerLockElement === container) {
                             document.exitPointerLock();
                             if (gameState.running) togglePause();
                         }
                    }
                });
            }

            // --- GAME FLOW & STATE ---
            function startGame(isRestart = false) {
                 if (!isRestart) {
                    showScreen('game');
                    container.requestPointerLock();
                 }
                 startCountdown(3, () => {
                    resetState();
                    gameState.running = true;
                    gameState.paused = false;
                    gameState.startTime = performance.now();
                    setupScenario();
                 });
            }
            
            function endGame() {
                gameState.running = false;
                showSummary();
                document.exitPointerLock();
            }

            function togglePause() {
                if (!gameState.running) return;
                gameState.paused = !gameState.paused;
                showScreen(gameState.paused ? 'pause' : 'game');
                if (!gameState.paused) {
                    container.requestPointerLock();
                    gameState.startTime += performance.now() - gameState.pauseTime;
                } else {
                    gameState.pauseTime = performance.now();
                }
            }
            
            function lockChangeAlert() {
                if (document.pointerLockElement === container) {
                    document.addEventListener("mousemove", updateCameraPosition, false);
                } else {
                    document.removeEventListener("mousemove", updateCameraPosition, false);
                    if (gameState.running && !gameState.paused) togglePause();
                }
            }

            function updateCameraPosition(e) {
                camera.rotateOnWorldAxis(new THREE.Vector3(0, 1, 0), -e.movementX * 0.002);
                camera.rotateX( -e.movementY * 0.002);
                camera.rotation.z = 0; // Prevent camera roll
                // Clamp vertical rotation
                const maxAngle = Math.PI / 2 - 0.1;
                camera.rotation.x = Math.max(-maxAngle, Math.min(maxAngle, camera.rotation.x));
            }

            function resetState() {
                stats = { hits: 0, misses: 0, totalShots: 0, reactionTimes: [], score: 0 };
                targets.forEach(t => scene.remove(t));
                targets = [];
            }

            function setupScenario() {
                const scenarios = { TileFrenzy, TargetSwitching, FlickShot };
                scenarios[gameState.mode]();
            }

            function TileFrenzy() {
                spawnTargets(3);
                document.getElementById('targets-hit-label').classList.add('hidden');
                document.getElementById('time-remaining').parentElement.classList.remove('hidden');
            }
            function TargetSwitching() {
                spawnTargets(6);
                document.getElementById('targets-hit-label').classList.add('hidden');
                document.getElementById('time-remaining').parentElement.classList.remove('hidden');
            }
            function FlickShot() {
                stats.totalTargets = 30;
                spawnTargets(1);
                document.getElementById('targets-hit-label').classList.remove('hidden');
                document.getElementById('time-remaining').parentElement.classList.add('hidden');
            }


            // --- CORE LOOP ---
            function animate(timestamp) {
                gameState.animationFrameId = requestAnimationFrame(animate);
                if (!gameState.running || gameState.paused) {
                    renderer.render(scene, camera); // Render even when paused to show pause screen correctly
                    return;
                };

                const deltaTime = (timestamp - lastFrameTime) / 1000;
                lastFrameTime = timestamp;
                
                update(timestamp);
                renderer.render(scene, camera);
                updateHUD(timestamp, deltaTime);
            }

            function update(timestamp) {
                const elapsedTime = timestamp - gameState.startTime;
                
                if (gameState.mode !== 'FlickShot') { // Timed modes
                    if (elapsedTime >= gameState.duration * 1000) {
                        endGame();
                    }
                } else { // FlickShot mode
                    if (stats.hits + stats.misses >= stats.totalTargets) {
                        endGame();
                    }
                }
            }
            
            // --- GAME MECHANICS ---
            function shoot() {
                if (gameState.clickCooldown) return;
                playSound(sounds.shoot);
                gameState.clickCooldown = true;
                setTimeout(() => { gameState.clickCooldown = false; }, 120);

                raycaster.setFromCamera({ x: 0, y: 0 }, camera); // Ray from center of screen
                const intersects = raycaster.intersectObjects(targets);

                if (intersects.length > 0) {
                    const hitTarget = intersects[0].object;
                    handleHit(hitTarget);
                } else {
                    handleMiss();
                }
                stats.totalShots++;
            }

            function handleHit(target) {
                playSound(sounds.hit);
                stats.hits++;
                stats.reactionTimes.push(performance.now() - target.userData.spawnTime);
                stats.score += 100;
                
                // Visual feedback
                target.material = targetHitMaterial;
                container.classList.add('shake');
                setTimeout(() => container.classList.remove('shake'), 80);
                
                setTimeout(() => {
                    scene.remove(target);
                    targets = targets.filter(t => t !== target);

                    // Respawn logic
                    if (gameState.mode === 'TileFrenzy' || gameState.mode === 'TargetSwitching') {
                        spawnTargets(1);
                    } else if (gameState.mode === 'FlickShot' && stats.hits + stats.misses < stats.totalTargets) {
                        spawnTargets(1);
                    }
                }, 100);
            }

            function handleMiss() {
                stats.misses++;
            }

            function spawnTargets(count) {
                for(let i = 0; i < count; i++) {
                    const target = new THREE.Mesh(targetGeometry, targetMaterial.clone());
                    
                    const phi = Math.random() * Math.PI * 2; // horizontal angle
                    const theta = Math.acos((Math.random() * 2) - 1); // vertical angle (ensures uniform distribution)
                    const radius = ARENA_SIZE / 2 - 2;

                    target.position.setFromSphericalCoords(radius, theta, phi);
                    
                    // Ensure target is not behind player and not too close
                    if (target.position.z > -2) target.position.z = - (Math.random() * (radius - 2) + 2);
                    
                    target.lookAt(camera.position); // Face the player
                    target.userData.spawnTime = performance.now();
                    
                    targets.push(target);
                    scene.add(target);
                }
            }

            // --- UI & HUD ---
            function updateHUD(timestamp, deltaTime) {
                // Update FPS counter
                const fps = Math.round(1 / deltaTime);
                document.getElementById('fps').textContent = fps;
                
                // Update stats
                document.getElementById('score').textContent = stats.score;
                const accuracy = stats.totalShots > 0 ? (stats.hits / stats.totalShots) * 100 : 100;
                document.getElementById('accuracy').textContent = accuracy.toFixed(1);

                // Update mode-specific HUD
                if (gameState.mode !== 'FlickShot') {
                    const timeRemaining = Math.max(0, gameState.duration - (timestamp - gameState.startTime) / 1000);
                    document.getElementById('time-remaining').textContent = timeRemaining.toFixed(1);
                } else {
                    document.getElementById('hits').textContent = stats.hits;
                    document.getElementById('total-targets').textContent = stats.totalTargets;
                }
            }

            function showSummary() {
                const accuracy = stats.totalShots === 0 ? 0 : (stats.hits / stats.totalShots) * 100;
                const avgTTK = stats.reactionTimes.length === 0 ? 0 : (stats.reactionTimes.reduce((a, b) => a + b, 0) / stats.reactionTimes.length);
                const score = stats.score;
                
                const highScoreKey = `shaank_hs_${gameState.mode}_${gameState.duration}`;
                const currentHighScore = localStorage.getItem(highScoreKey) || 0;
                
                let newHighScore = false;
                if (score > currentHighScore) {
                    localStorage.setItem(highScoreKey, score);
                    newHighScore = true;
                }
                
                document.getElementById('summary-score').textContent = score;
                const hsEl = document.getElementById('summary-highscore');
                hsEl.textContent = Math.max(score, currentHighScore);
                hsEl.classList.toggle('high-score', newHighScore);
                document.getElementById('summary-accuracy').textContent = `${accuracy.toFixed(1)}%`;
                document.getElementById('summary-avg-ttk').textContent = `${avgTTK.toFixed(0)}ms`;

                document.getElementById('summary-title').textContent = newHighScore ? "New High Score!" : "Scenario Complete!";
                showScreen('summary');
            }
            
            function showScreen(screenName) {
                document.getElementById('start-menu').classList.add('hidden');
                document.getElementById('hud').classList.add('hidden');
                document.getElementById('pause-menu').classList.add('hidden');
                document.getElementById('summary-screen').classList.add('hidden');
                reticle.classList.add('hidden');

                if (screenName === 'game') {
                    hud.classList.remove('hidden');
                    reticle.classList.remove('hidden');
                } else {
                    document.getElementById(screenName).classList.remove('hidden');
                }
            }
            
            function startCountdown(seconds, callback) {
                let count = seconds;
                const countdownEl = document.getElementById('countdown');
                countdownEl.textContent = count;
                countdownEl.classList.remove('hidden');
                const interval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownEl.textContent = count;
                    } else {
                        clearInterval(interval);
                        countdownEl.classList.add('hidden');
                        callback();
                    }
                }, 1000);
            }
            
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            function changeReticle() {
                currentReticleIndex = (currentReticleIndex + 1) % reticleStyles.length;
                reticle.className = reticleStyles[currentReticleIndex];
            }
            function updateActiveButton(containerSelector, activeButton) {
                document.querySelectorAll(`${containerSelector} button`).forEach(b => b.classList.remove('active'));
                activeButton.classList.add('active');
            }
            function playSound(sound) {
                sound.currentTime = 0;
                sound.play().catch(e => {}); // Ignore errors if sound can't play
            }
            
            init();
        });
    </script>
</body>
</html>
